{% extends "base.html" %}

{% block title %}Lista de Usuarios{% endblock %}

{% block content %}

<style>
.user-card {
border: 1px solid #dbdbdb;
border-radius: 6px;
padding: 1.5rem;
}

.user-detail-p {
margin-bottom: 0.25em !important;
}
</style>

<div class="container mt-6">
<h1 class="title is-5 has-text-centered">¡Usuarios Registrados!</h1>

<div class="field">
<div class="control has-icons-left">
<input id="search-input" class="input is-rounded is-medium" type="text" placeholder="Buscar Usuario">
<span class="icon is-left">
<i class="fas fa-search"></i>
</span>
</div>
</div>

<div id="users-container" class="columns is-multiline is-mobile is-centered is-hidden-980 mb-6">
{% for user in users %}
<div class="column is-12-mobile is-10-tablet is-4-desktop user-card-column ">
<div class="is-rounded user-card">
<div class="content">
<div class="media">
<div class="media-content">
<p class="title is-4 has-text-warning">{{ user.nombre }} {{ user.primer_apellido }}</p>
<p class="subtitle is-6 has-text-grey">@{{ user.usuario }}</p>
</div>
</div>
<div class="content">
<p class="user-detail-p"><strong>Teléfono:</strong> <span class="user-phone">{{ user.telefono }}</span></p>
<br>
<div class="buttons is-centered is-flex is-flex-wrap-nowrap">
<a href="{{ url_for('detalle_usuario', user_id=user.id) }}" class="button is-info is-rounded is-small">
<span class="icon"><i class="fas fa-eye"></i></span>
<span>Ver más</span>
</a>
{% if current_user.rol == 'Superusuario' and user.id != current_user.id %}
<button onclick="confirmDelete({{ user.id }}, '{{ user.nombre }} {{ user.primer_apellido }}'); return false;" class="button is-danger is-rounded is-small">
<span class="icon"><i class="fas fa-trash"></i></span>
<span>Eliminar</span>
</button>
{% endif %}
</div>
</div>
</div>
</div>
</div>
{% endfor %}
</div>

<table id="users-table" class="table is-striped is-hoverable is-fullwidth is-hidden-980-down">
<thead>
<tr>
<th>ID</th>
<th>Nombre</th>
<th>Usuario</th>
<th>Teléfono</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for user in users %}
<tr>
<td>{{ user.id }}</td>
<td>{{ user.nombre }} {{ user.primer_apellido }}</td>
<td>{{ user.usuario }}</td>
<td>{{ user.telefono }}</td>
<td>
<div class="buttons is-small">
<a href="{{ url_for('detalle_usuario', user_id=user.id) }}" class="button is-info is-light">
<span class="icon"><i class="fas fa-eye"></i></span>
<span>Ver más</span>
</a>
{% if current_user.rol == 'Superusuario' and user.id != current_user.id %}
<button onclick="confirmDelete({{ user.id }}, '{{ user.nombre }} {{ user.primer_apellido }}'); return false;" class="button is-danger is-light">
<span class="icon"><i class="fas fa-trash"></i></span>
<span>Eliminar</span>
</button>
{% endif %}
</div>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
function confirmDelete(userId, userName) {
    if (confirm('¿Estás seguro de que deseas eliminar al usuario ' + userName + '?')) {
        fetch('/usuarios/' + userId + '/eliminar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error al eliminar el usuario: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('Error al eliminar el usuario');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const usersTable = document.getElementById('users-table');
    const userCards = document.querySelectorAll('.user-card-column');
    const mediaQuery = window.matchMedia('(max-width: 979px)');

    function filterUsers(searchTerm) {
        const filterText = searchTerm.toLowerCase();

        // Filtrar tarjetas
        userCards.forEach(function(card) {
            const cardContent = card.textContent.toLowerCase();
            if (cardContent.includes(filterText) || filterText === '') {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Filtrar tabla
        if (usersTable) {
            const rows = usersTable.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowContent = row.textContent.toLowerCase();
                if (rowContent.includes(filterText) || filterText === '') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
    }

    function handleMediaQuery(mediaQuery) {
        if (mediaQuery.matches) {
            // Mobile view
            if (usersTable) usersTable.style.display = 'none';
            const container = document.getElementById('users-container');
            if (container) container.style.display = 'flex';
        } else {
            // Desktop view
            if (usersTable) usersTable.style.display = 'table';
            const container = document.getElementById('users-container');
            if (container) container.style.display = 'none';
        }
    }

    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            filterUsers(e.target.value);
        });
    }

    // Initialize media query handler
    mediaQuery.addListener(handleMediaQuery);
    handleMediaQuery(mediaQuery);
});
</script>

{% endblock %}